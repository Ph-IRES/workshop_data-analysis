---
title: "striped_bass_msats_npop"
output: html_document
date: "2024-07-11"
---

```{r setup, include=FALSE}

if (!require(genepop)) install.packages('genepop')
if (!require(ggplot2)) install.packages('ggplot2')
if (!require(dplyr)) install.packages('dplyr')
if (!require('adegenet')) install.packages('adegenet')
if (!require('pegas')) install.packages('pegas')
if (!require('hierfstat')) install.packages("hierfstat")
library('genepop')
library('ggplot2')
library('dplyr')
library('adegenet')
library('pegas')
library('hierfstat')




#Sets working directory
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

#sets a variable for your data file
locinfile <- "../data/fish/SBmicro_pops.txt"

```
```{r functions from GenePop2: null alleles, genotype frequencies, HW exact tests, linkage disequilibrium, IBD, private alleles}
##functions in GenePop2

#Null alleles
nulls(locinfile, outputFile = "../output/fish/nulls.out")

#Allele and genotype frequencies per locus and per sample. 
basic_info(locinfile, outputFile = "../output/fish/basic.out", verbose = interactive())

#Compute variants of the exact conditional test for Hardy-Weinberg genotypic proportions. 
test_HW(locinfile, which = "Proba", outputFile = "../output/fish/SB_HW.out",
        settingsFile = "", enumeration = FALSE, dememorization = 10000,
        batches = 20, iterations = 5000, verbose = interactive())

#Exact test for genotypic linkage disequilibrium for each pair of loci in each population.
test_LD(locinfile, outputFile = "../output/fish/SB_LD.out", settingsFile = "",
        dememorization = 10000, batches = 100, iterations = 5000,
        verbose = interactive())

#Evaluates Fst or related measures based on allele sizes, for all populations of for all pairs of populations.
Fst(locinfile, sizes = FALSE, pairs = TRUE, outputFile = "../output/fish/SB_FST.out",
    dataType = "Diploid", verbose = interactive())

# Convert genepop data to genind object (required for p-values)
genind_data <- read.genepop("../data/fish/SBmicro_pops.gen", ncode = 3)

# Calculate fst matrix from hierfstat
fst_matrix <- pairwise.WCfst(genind_data)

#95% confidence intervals.
fst_ci <- boot.ppfst(genind_data, nboot = 100)

#note here that a special Genepop format is needed where every fish is a population and every sample name is coordinates

# Estimates isolation by distance by regression of genetic distance to geographical distance. 

###this needs to include geographic data
#File specification is for each individual to be a population and the name of each individual is its coordinates.
ibd('../data/fish/SBmicro_pops_dist.txt', '../output/fish/SB_FST.out.MIG', dataType='diploid', geographicScale = 'Linear', statistic = 'SingleGeneDiv', mantelRankTest=TRUE)

#migration via private alleles
Nm_private(locinfile, outputFile = "../output/fish/SBmicro_pops.txt.PRI ", dataType = "Diploid",
           verbose = interactive())
```
```{r functions from adegenet}
##generate genind object
sb_genind <- genepop_to_genind(locinfile, 14, pop_names = c("HR","DB","CB","NC","SC"))

#summarize genind object
sum_sb_genind <- (summary(sb_genind))
sum_sb_genind

#polymorphic loci
poly<-isPoly(sb_genind, by=c("locus"))
poly

#locus completeness
locmiss_sb <- propTyped(sb_genind, by = "loc")
barplot(locmiss_sb, ylim = c(0,1), ylab = "Complete genotypes (proportion)", xlab = "Locus", las = 2, cex.names = 0.7)

#private alleles
private_alleles(sb_genind) %>% apply(MARGIN = 1, FUN = sum)

#expected and observed heterozygosity
locus <- levels(sb_genind@loc.fac)
observed.hetero<- sum_sb_genind$Hobs
expected.hetero<- sum_sb_genind$Hexp 

my_table <- data.frame(locus = locus, observed.hetero = observed.hetero, expected.hetero = expected.hetero) |>
  mutate (deltaH = expected.hetero-observed.hetero)

table_long <- pivot_longer(my_table, c(expected.hetero,observed.hetero), names_to = "het")

het_plot <- ggplot(table_long, aes(x = locus)) +
  geom_bar(aes(y = value, fill=het), stat = "identity", position = position_dodge()) +
  theme(axis.text.x = element_text(size = 6),
panel.background = element_blank())

plot(het_plot)

#Fst values
sb_fst <- genet.dist(sb_genind, method = "WC84") %>% round(digits = 3)
sb_fst

#95% confidence intervals for global statistics
msat_hf <- genind2hierfstat(sb_genind)
boot.vc(msat_hf[1], msat_hf[-1])$ci
msat_hf 


#Discriminant analysis of Principal Components (DAPC)

find.clusters()

#Perform cross validation to find the optimal number of PCs to retain in DAPC
set.seed(123)
x <- tab(sb_genind, NA.method = "mean")
crossval = xvalDapc(x, sb_genind$pop, result = "groupMean", xval.plot = TRUE)

# Number of PCs with best stats (lower score = better)
crossval$`Root Mean Squared Error by Number of PCs of PCA`

crossval$`Number of PCs Achieving Highest Mean Success`

crossval$`Number of PCs Achieving Lowest MSE`

numPCs <- as.numeric(crossval$`Number of PCs Achieving Lowest MSE`)

#find number of genetic clusters
grp <- find.clusters(x, n.pca = numPCs, max.n = 12, n.clust = NULL)
plot(grp$Kstat, type="b", col="blue")

# Run a DAPC using site IDs as priors
dapc1 <- dapc(sb_genind, sb_genind$pop, n.pca = numPCs, n.da = 3)

# Analyse how much percent of genetic variance is explained by each axis
percent <- dapc1$eig/sum(dapc1$eig)*100
barplot(percent, ylab = "Genetic variance explained by eigenvectors (%)", ylim = c(0,60),
        names.arg = round(percent, 1))

# Create a data.frame containing individual coordinates
ind_coords <- as.data.frame(dapc1$ind.coord)

# Rename columns of dataframe
colnames(ind_coords) <- c("Axis1","Axis2","Axis3")

# Add a column containing individuals
ind_coords$Ind <- indNames(sb_genind)

# Add a column with the site IDs
ind_coords$Site <- sb_genind$pop

# Calculate centroid (average) position for each population
centroid <- aggregate(cbind(Axis1, Axis2, Axis3) ~ Site, data = ind_coords, FUN = mean)

# Add centroid coordinates to ind_coords dataframe
ind_coords <- left_join(ind_coords, centroid, by = "Site", suffix = c("",".cen"))

# Define colour palette
cols <- brewer.pal(nPop(sb_genind), "Set2")

# Custom x and y labels
xlab = paste("Axis 1 (", format(round(percent[1], 1), nsmall=1)," %)", sep="")
ylab = paste("Axis 2 (", format(round(percent[2], 1), nsmall=1)," %)", sep="")

# Scatter plot axis 1 vs. 2
ggplot(data = ind_coords, aes(x = Axis1, y = Axis2))+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  # spider segments
  geom_segment(aes(xend = Axis1.cen, yend = Axis2.cen, colour = Site), show.legend = FALSE)+
  # points
  geom_point(aes(fill = Site), shape = 21, size = 3, show.legend = FALSE)+
  # centroids
  geom_label(data = centroid, aes(label = Site, fill = Site), size = 4, show.legend = FALSE)+
  # colouring
  scale_fill_manual(values = cols)+
  scale_colour_manual(values = cols)+
  # custom labels
  labs(x = xlab, y = ylab)+
  ggtitle("Striped bass DAPC")+
  # custom theme
  ggtheme

```
```{r structure analysis INCOMPLETE}
struct2geno("../data/fish/SBmicro_pops.structure", 2, FORMAT = 2, extra.row = 0, extra.column = 2)

obj.snmf = snmf("../data/fish/SBmicro_pops.structure.geno", K = 1:8, ploidy = 2, entropy = T,
alpha = 100, project = "new")
plot(obj.snmf, col = "blue4", cex = 1.4, pch = 19)

obj.snmf = snmf("../data/fish/SBmicro_pops.structure.geno", K = 3, alpha = 100, project = "new")
qmatrix = Q(obj.snmf, K = 3)
barplot(t(qmatrix), col = c("red","blue","lightgreen"), border = NA, space = 0,
xlab = "Individuals", ylab = "Admixture coefficients")

```

